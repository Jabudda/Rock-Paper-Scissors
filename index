<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />
  <title>RPS+ ‚Äî Mobile-First</title>
  <style>
    :root{
      /* ‚ÄúJobs would smile‚Äù vibe: calm, minimal, crisp */
      --bg0:#070a10;
      --bg1:#0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --line: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --radius: 20px;

      --good: #22c55e;
      --warn: #f59e0b;
      --bad:  #ef4444;

      --accent: #7c3aed;  /* subtle purple */
      --accent2:#06b6d4;  /* subtle cyan */
      --glow: rgba(124,58,237,.35);

      --tap: 56px;
      --max: 720px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(124,58,237,.18), transparent 55%),
        radial-gradient(900px 600px at 110% 20%, rgba(6,182,212,.14), transparent 60%),
        radial-gradient(700px 500px at 40% 120%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
    }

    /* subtle moving ‚Äúaurora‚Äù */
    .aurora{
      position:fixed; inset:-40px;
      pointer-events:none; z-index:0;
      filter: blur(20px);
      opacity:.55;
      background:
        radial-gradient(500px 260px at 20% 30%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(420px 240px at 70% 40%, rgba(6,182,212,.22), transparent 60%),
        radial-gradient(460px 260px at 40% 80%, rgba(34,197,94,.16), transparent 60%);
      animation: drift 14s ease-in-out infinite alternate;
    }
    @keyframes drift{
      from{ transform: translate3d(-10px,-10px,0) scale(1.02); }
      to  { transform: translate3d(10px,12px,0) scale(1.05); }
    }

    .wrap{
      position:relative; z-index:1;
      max-width: var(--max);
      margin: 0 auto;
      min-height: 100%;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 6px 0;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(124,58,237,.9), rgba(6,182,212,.8));
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-60%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(25deg);
      animation: shine 2.8s ease-in-out infinite;
    }
    @keyframes shine{
      0%{ transform: translateX(-40%) rotate(25deg); opacity:0; }
      35%{ opacity:.65; }
      100%{ transform: translateX(40%) rotate(25deg); opacity:0; }
    }

    .title{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .title strong{
      font-size: 1.05rem;
      letter-spacing:.2px;
    }
    .title span{
      font-size: .82rem; color: var(--muted);
    }

    .top-actions{
      display:flex; gap:10px; align-items:center;
    }

    .chip{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      font-size:.88rem;
      color: var(--muted);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 0 rgba(124,58,237,.0);
    }
    .dot.on{
      background: var(--good);
      animation: pulseDot 1.4s ease-in-out infinite;
    }
    @keyframes pulseDot{
      0%,100%{ box-shadow: 0 0 0 0 rgba(34,197,94,.0); }
      50%{ box-shadow: 0 0 0 10px rgba(34,197,94,.12); }
    }

    .btn-icon{
      width: 42px; height:42px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      display:grid; place-items:center;
      color: var(--text);
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    .btn-icon:active{ transform: scale(.97); }
    .btn-icon:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .hero{
      padding: 14px 14px 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .hero-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }

    .mode{
      display:flex; flex-direction:column; gap:4px;
    }
    .mode b{ font-size: 1.05rem; letter-spacing:.2px; }
    .mode small{ color: var(--muted); font-size: .85rem; }

    .toggles{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .seg{
      display:flex;
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 9px 12px;
      font-weight: 600;
      font-size:.85rem;
      cursor:pointer;
      transition: background .18s ease, color .18s ease;
    }
    .seg button.active{
      background: rgba(255,255,255,.10);
      color: var(--text);
    }

    .mini{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size:.85rem;
    }
    .mini input[type="range"]{ width: 120px; }
    .mini input{ accent-color: var(--accent2); }

    .arena{
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .cards{
      display:grid;
      grid-template-columns: 1fr 56px 1fr;
      align-items:center;
      gap: 10px;
    }

    .vs{
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(255,255,255,.78);
      opacity:.9;
    }
    .vs .badge{
      width: 56px; height:56px; border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
    }
    .vs .badge::after{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle, rgba(255,255,255,.18), transparent 60%);
      animation: slowSpin 6s linear infinite;
    }
    @keyframes slowSpin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }
    .vs .badge span{ position:relative; z-index:1; font-size: 1.2rem; }

    .card{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:flex; flex-direction:column; gap:10px;
      min-height: 120px;
      position:relative;
      overflow:hidden;
    }
    .card h3{
      margin:0;
      font-size:.85rem;
      color: var(--muted);
      letter-spacing:.12em;
      text-transform: uppercase;
    }

    .display{
      width: 100%;
      height: 74px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(160px 120px at 30% 10%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(160px 120px at 70% 90%, rgba(6,182,212,.18), transparent 60%),
        rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 2.1rem;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      user-select:none;
    }
    .display.active{
      transform: translateY(-1px) scale(1.02);
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 18px 45px rgba(0,0,0,.28);
    }

    .subrow{
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size:.86rem;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:.82rem;
      white-space:nowrap;
    }

    .result{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .resultbox{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding: 14px;
      min-height: 68px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      position:relative;
      overflow:hidden;
    }
    .resultbox::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
      transform: translateX(-120%);
      transition: transform .6s ease;
    }
    .resultbox.flash::before{ transform: translateX(120%); }

    .resulttext{
      font-size: 1.02rem;
      line-height:1.25;
    }
    .resultmeta{
      display:flex; flex-direction:column; gap:6px;
      align-items:flex-end;
      text-align:right;
      color: var(--muted);
      font-size:.82rem;
      min-width: 120px;
    }

    .tag{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight:800;
      letter-spacing:.06em;
      font-size:.74rem;
      text-transform: uppercase;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
    }
    .tag.win{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .tag.lose{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }
    .tag.tie{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:.78rem;
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.78);
      white-space:nowrap;
    }

    /* mobile-first big choice buttons */
    .choices{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .choiceBtn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 12px 10px;
      min-height: 92px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap: 6px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      box-shadow: 0 16px 35px rgba(0,0,0,.24);
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .choiceBtn:active{ transform: scale(.98); }
    .choiceBtn:hover{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.16); }
    .choiceBtn[disabled]{ opacity:.55; pointer-events:none; }
    .choiceEmoji{ font-size: 2.0rem; }
    .choiceName{ font-weight:800; letter-spacing:.08em; text-transform:uppercase; font-size:.72rem; color: rgba(255,255,255,.80); }
    .choiceHint{ font-size:.78rem; color: var(--muted); }

    .choiceBtn.selected{
      border-color: rgba(6,182,212,.35);
      box-shadow: 0 0 0 8px rgba(6,182,212,.08), 0 18px 45px rgba(0,0,0,.30);
    }

    .score{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .stat{
      padding: 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      text-align:center;
    }
    .stat small{ display:block; color: var(--muted); text-transform:uppercase; letter-spacing:.14em; font-size:.72rem; }
    .stat b{ display:block; font-size: 1.6rem; margin-top: 6px; }

    .progress{
      margin-top: 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      height: 12px;
      position:relative;
    }
    .bar{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(6,182,212,.95));
      box-shadow: 0 0 24px rgba(124,58,237,.35);
      transition: width .35s ease;
    }

    .footer-actions{
      padding: 12px 14px 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items:center;
    }

    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size:.78rem;
      min-height: 44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      box-shadow: 0 16px 35px rgba(0,0,0,.22);
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
    .btn.primary{
      border-color: rgba(124,58,237,.35);
      background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(6,182,212,.18));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.32);
      background: rgba(239,68,68,.10);
    }
    .btn.ghost{
      background: transparent;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom) + 14px);
      transform: translateX(-50%) translateY(18px);
      opacity:0;
      pointer-events:none;
      background: rgba(10,14,22,.75);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      transition: opacity .2s ease, transform .2s ease;
      z-index: 50;
      max-width: calc(100% - 28px);
      display:flex; align-items:center; gap:10px;
      font-size:.9rem;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    dialog{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,14,22,.92);
      color: var(--text);
      border-radius: 18px;
      width: min(680px, calc(100% - 24px));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      padding: 0;
      overflow:hidden;
    }
    dialog::backdrop{
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .modalHead b{ letter-spacing:.2px; }
    .modalBody{ padding: 14px; display:flex; flex-direction:column; gap: 12px; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 10px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
    }
    .row label{ color: var(--muted); font-size:.9rem; }
    .row input[type="range"]{ width: 160px; }
    .row select, .row input[type="checkbox"]{ accent-color: var(--accent2); }
    .hint{
      color: var(--muted);
      font-size:.88rem;
      line-height:1.25;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 680px){
      body{ padding-left: 18px; padding-right: 18px; }
      .grid2{ grid-template-columns: 1fr 1fr; }
      .hero{ padding: 16px 18px 12px; }
      .arena, .result, .footer-actions{ padding-left: 18px; padding-right: 18px; }
      .choices{ gap: 12px; }
      .choiceBtn{ min-height: 110px; }
      .choiceEmoji{ font-size: 2.35rem; }
      .choiceName{ font-size:.78rem; }
    }

    /* reduce motion support */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
      .aurora{ display:none; }
    }
  </style>
</head>

<body>
  <div class="aurora" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="brand" title="RPS+">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <strong>RPS+</strong>
          <span>mobile-first ‚Ä¢ clean ‚Ä¢ unfairly fun</span>
        </div>
      </div>

      <div class="top-actions">
        <div class="chip" id="streakChip" title="Win streak">
          <span class="dot" id="streakDot"></span>
          <span id="streakText">Streak: 0</span>
        </div>
        <button class="btn-icon" id="settingsBtn" aria-label="Settings" title="Settings">‚öôÔ∏è</button>
      </div>
    </header>

    <section class="panel hero">
      <div class="hero-top">
        <div class="mode">
          <b id="modeTitle">Classic</b>
          <small id="modeSub">Rock ‚Ä¢ Paper ‚Ä¢ Scissors</small>
        </div>

        <div class="toggles">
          <div class="seg" role="tablist" aria-label="Mode">
            <button id="modeClassic" class="active" onclick="setMode('classic')" role="tab">Classic</button>
            <button id="modeLizard" onclick="setMode('rpsls')" role="tab">RPSLS</button>
          </div>

          <div class="mini" title="First to N wins">
            <span>üèÅ</span>
            <span>First to</span>
            <input id="firstTo" type="range" min="3" max="15" step="1" value="7" oninput="updateFirstTo(this.value)" />
            <span id="firstToVal" class="kbd">7</span>
          </div>
        </div>
      </div>

      <div class="hint" id="microHint">
        Tip: tap a move, or use keyboard <span class="kbd">R</span> <span class="kbd">P</span> <span class="kbd">S</span> (desktop).
      </div>
    </section>

    <section class="panel arena">
      <div class="cards">
        <div class="card">
          <h3>You</h3>
          <div class="display" id="playerDisplay">‚ùì</div>
          <div class="subrow">
            <span class="pill" id="playerBiasPill">Skill: <span class="kbd" id="skillVal">50</span></span>
            <span class="pill">Last: <span class="kbd" id="lastPlayer">‚Äî</span></span>
          </div>
        </div>

        <div class="vs">
          <div class="badge" title="vs"><span>‚öîÔ∏è</span></div>
        </div>

        <div class="card">
          <h3>Computer</h3>
          <div class="display" id="computerDisplay">‚ùì</div>
          <div class="subrow">
            <span class="pill">Mood: <span class="kbd" id="cpuMood">Zen</span></span>
            <span class="pill">Last: <span class="kbd" id="lastCpu">‚Äî</span></span>
          </div>
        </div>
      </div>

      <div class="choices" id="choices"></div>
    </section>

    <section class="panel result">
      <div class="resultbox" id="resultBox">
        <div class="resulttext" id="resultText">Make your move. Clean victory awaits. üëÜ</div>
        <div class="resultmeta">
          <span class="tag" id="resultTag">READY</span>
          <span id="roundMeta">Round <span class="kbd" id="roundNum">1</span></span>
        </div>
      </div>

      <div class="score">
        <div class="stat"><small>Wins</small><b id="wins">0</b></div>
        <div class="stat"><small>Losses</small><b id="losses">0</b></div>
        <div class="stat"><small>Ties</small><b id="ties">0</b></div>
      </div>

      <div class="hint">
        Match progress to <span class="kbd" id="firstToLabel">7</span> wins:
      </div>
      <div class="progress" aria-label="Match progress">
        <div class="bar" id="bar"></div>
      </div>
    </section>

    <section class="panel footer-actions">
      <button class="btn primary" id="autoplayBtn" onclick="toggleAutoPlay()">‚ñ∂Ô∏è Auto</button>
      <button class="btn ghost" onclick="copyStats()">üìã Copy</button>
      <button class="btn ghost" onclick="shareScore()">üì§ Share</button>
      <button class="btn danger" onclick="resetGame()">üîÑ Reset</button>
    </section>
  </div>

  <div class="toast" id="toast">‚úÖ Done</div>

  <dialog id="settingsModal">
    <div class="modalHead">
      <b>Settings</b>
      <button class="btn-icon" onclick="closeSettings()" aria-label="Close">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="grid2">
        <div class="row">
          <label for="skill">Skill (CPU adapts)</label>
          <input id="skill" type="range" min="0" max="100" value="50" oninput="setSkill(this.value)" />
          <span class="kbd" id="skillKbd">50</span>
        </div>

        <div class="row">
          <label for="haptics">Haptics (mobile)</label>
          <input id="haptics" type="checkbox" checked onchange="setHaptics(this.checked)" />
          <span class="kbd" id="hapticsKbd">ON</span>
        </div>

        <div class="row">
          <label for="sounds">Sounds</label>
          <input id="sounds" type="checkbox" checked onchange="setSounds(this.checked)" />
          <span class="kbd" id="soundsKbd">ON</span>
        </div>

        <div class="row">
          <label for="confetti">Confetti on win</label>
          <input id="confetti" type="checkbox" checked onchange="setConfetti(this.checked)" />
          <span class="kbd" id="confettiKbd">ON</span>
        </div>
      </div>

      <div class="hint">
        Bonus variables included:
        <ul style="margin:8px 0 0 18px; color: rgba(255,255,255,.74); line-height:1.35;">
          <li><b>Skill</b>: CPU learns your tendencies (but doesn‚Äôt ‚Äúcheat‚Äù ‚Ä¶much).</li>
          <li><b>First-to</b>: match format, progress bar + match end celebration.</li>
          <li><b>RPSLS</b> mode: Rock Paper Scissors Lizard Spock.</li>
          <li><b>Share/Copy</b>: one-tap bragging rights.</li>
        </ul>
      </div>

      <div class="row" style="justify-content:flex-end;">
        <button class="btn primary" onclick="closeSettings()">Done</button>
      </div>
    </div>
  </dialog>

  <canvas id="confettiCanvas" style="position:fixed; inset:0; pointer-events:none; z-index:40;"></canvas>

  <script>
    // -----------------------------
    // RPS+ ‚Äî mobile-first, fun extras
    // -----------------------------

    // State
    const LS_KEY = "rps_plus_v1";
    let state = {
      mode: "classic", // classic | rpsls
      score: { wins: 0, losses: 0, ties: 0 },
      streak: 0,
      round: 1,
      firstTo: 7,
      autoplay: false,
      autoplayId: null,

      // "bonus variables"
      skill: 50,          // 0..100 CPU adapts to your tendencies
      haptics: true,
      sounds: true,
      confetti: true,

      // lightweight pattern tracking
      history: {
        player: [],
        cpu: []
      }
    };

    // Modes
    const MODES = {
      classic: {
        title: "Classic",
        sub: "Rock ‚Ä¢ Paper ‚Ä¢ Scissors",
        moves: ["rock","paper","scissors"],
        emoji: { rock:"ü™®", paper:"üìÑ", scissors:"‚úÇÔ∏è" },
        keys: { r:"rock", p:"paper", s:"scissors" }
      },
      rpsls: {
        title: "RPSLS",
        sub: "Rock ‚Ä¢ Paper ‚Ä¢ Scissors ‚Ä¢ Lizard ‚Ä¢ Spock",
        moves: ["rock","paper","scissors","lizard","spock"],
        emoji: { rock:"ü™®", paper:"üìÑ", scissors:"‚úÇÔ∏è", lizard:"ü¶é", spock:"üññ" },
        keys: { r:"rock", p:"paper", s:"scissors", l:"lizard", k:"spock" } // k for spocK
      }
    };

    // Rules: who beats who
    const BEATS = {
      rock:     new Set(["scissors","lizard"]),
      paper:    new Set(["rock","spock"]),
      scissors: new Set(["paper","lizard"]),
      lizard:   new Set(["paper","spock"]),
      spock:    new Set(["scissors","rock"])
    };

    // Elements
    const el = {
      choices: document.getElementById("choices"),
      playerDisplay: document.getElementById("playerDisplay"),
      cpuDisplay: document.getElementById("computerDisplay"),
      resultText: document.getElementById("resultText"),
      resultTag: document.getElementById("resultTag"),
      resultBox: document.getElementById("resultBox"),

      wins: document.getElementById("wins"),
      losses: document.getElementById("losses"),
      ties: document.getElementById("ties"),
      bar: document.getElementById("bar"),

      modeTitle: document.getElementById("modeTitle"),
      modeSub: document.getElementById("modeSub"),

      streakText: document.getElementById("streakText"),
      streakDot: document.getElementById("streakDot"),
      roundNum: document.getElementById("roundNum"),

      lastPlayer: document.getElementById("lastPlayer"),
      lastCpu: document.getElementById("lastCpu"),
      cpuMood: document.getElementById("cpuMood"),

      firstTo: document.getElementById("firstTo"),
      firstToVal: document.getElementById("firstToVal"),
      firstToLabel: document.getElementById("firstToLabel"),

      settingsBtn: document.getElementById("settingsBtn"),
      settingsModal: document.getElementById("settingsModal"),

      skill: document.getElementById("skill"),
      skillKbd: document.getElementById("skillKbd"),
      skillVal: document.getElementById("skillVal"),

      haptics: document.getElementById("haptics"),
      hapticsKbd: document.getElementById("hapticsKbd"),
      sounds: document.getElementById("sounds"),
      soundsKbd: document.getElementById("soundsKbd"),
      confetti: document.getElementById("confetti"),
      confettiKbd: document.getElementById("confettiKbd"),

      autoplayBtn: document.getElementById("autoplayBtn"),
      toast: document.getElementById("toast"),

      confettiCanvas: document.getElementById("confettiCanvas")
    };

    // Sound (tiny, tasteful beeps via WebAudio)
    let audioCtx = null;
    function beep(type="tap"){
      if (!state.sounds) return;
      try{
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const t0 = audioCtx.currentTime;

        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);

        const freq = type==="win" ? 880 : type==="lose" ? 220 : type==="tie" ? 440 : 560;
        o.frequency.setValueAtTime(freq, t0);
        o.type = "sine";

        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.12, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);

        o.start(t0);
        o.stop(t0 + 0.2);
      }catch(e){}
    }

    // Haptics
    function buzz(pattern=15){
      if (!state.haptics) return;
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    // Toast
    let toastTimer = null;
    function showToast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.toast.classList.remove("show"), 1400);
    }

    // Persist
    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        // Merge safely
        state = {
          ...state,
          ...saved,
          score: { ...state.score, ...(saved.score||{}) },
          history: { player: (saved.history?.player||[]), cpu: (saved.history?.cpu||[]) }
        };
      }catch(e){}
    }
    function save(){
      try{
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      }catch(e){}
    }

    // UI builders
    function renderChoices(){
      const mode = MODES[state.mode];
      el.choices.innerHTML = "";
      mode.moves.forEach(m=>{
        const btn = document.createElement("button");
        btn.className = "choiceBtn";
        btn.type = "button";
        btn.setAttribute("data-move", m);
        btn.innerHTML = `
          <div class="choiceEmoji">${mode.emoji[m]}</div>
          <div class="choiceName">${m}</div>
          <div class="choiceHint">${hintFor(m)}</div>
        `;
        btn.addEventListener("click", ()=> play(m));
        el.choices.appendChild(btn);
      });
    }

    function hintFor(move){
      if (state.mode === "classic"){
        if (move==="rock") return "break it";
        if (move==="paper") return "wrap it";
        if (move==="scissors") return "snip it";
      }else{
        if (move==="lizard") return "chomp it";
        if (move==="spock") return "logic it";
        // keep others subtle
        if (move==="rock") return "crush it";
        if (move==="paper") return "cover it";
        if (move==="scissors") return "cut it";
      }
      return "";
    }

    function updateHeader(){
      const mode = MODES[state.mode];
      el.modeTitle.textContent = mode.title;
      el.modeSub.textContent = mode.sub;

      el.firstTo.value = String(state.firstTo);
      el.firstToVal.textContent = String(state.firstTo);
      el.firstToLabel.textContent = String(state.firstTo);

      el.skill.value = String(state.skill);
      el.skillKbd.textContent = String(state.skill);
      el.skillVal.textContent = String(state.skill);

      el.haptics.checked = !!state.haptics;
      el.sounds.checked = !!state.sounds;
      el.confetti.checked = !!state.confetti;

      el.hapticsKbd.textContent = state.haptics ? "ON" : "OFF";
      el.soundsKbd.textContent = state.sounds ? "ON" : "OFF";
      el.confettiKbd.textContent = state.confetti ? "ON" : "OFF";

      el.roundNum.textContent = String(state.round);

      el.streakText.textContent = `Streak: ${state.streak}`;
      el.streakDot.classList.toggle("on", state.streak >= 3);

      // CPU ‚Äúmood‚Äù based on skill
      el.cpuMood.textContent = state.skill < 35 ? "Chill" : state.skill < 70 ? "Sharp" : "Spicy";
    }

    function updateScoreUI(){
      el.wins.textContent = String(state.score.wins);
      el.losses.textContent = String(state.score.losses);
      el.ties.textContent = String(state.score.ties);
      const pct = Math.min(100, (state.score.wins / state.firstTo) * 100);
      el.bar.style.width = pct + "%";
    }

    function setTag(type){
      el.resultTag.className = "tag";
      if (type==="win") { el.resultTag.classList.add("win"); el.resultTag.textContent="WIN"; }
      else if (type==="lose") { el.resultTag.classList.add("lose"); el.resultTag.textContent="LOSS"; }
      else if (type==="tie") { el.resultTag.classList.add("tie"); el.resultTag.textContent="TIE"; }
      else { el.resultTag.textContent="READY"; }
    }

    function flashResult(){
      el.resultBox.classList.remove("flash");
      // force reflow
      void el.resultBox.offsetWidth;
      el.resultBox.classList.add("flash");
    }

    function setMode(mode){
      if (!MODES[mode]) return;
      state.mode = mode;
      // reset match pacing without nuking lifetime score
      state.round = 1;
      state.streak = 0;
      state.history.player = [];
      state.history.cpu = [];
      el.playerDisplay.textContent = "‚ùì";
      el.cpuDisplay.textContent = "‚ùì";
      el.lastPlayer.textContent = "‚Äî";
      el.lastCpu.textContent = "‚Äî";
      el.resultText.textContent = "Mode switched. Make your move. üëÜ";
      setTag("ready");
      flashResult();

      // button UI
      document.getElementById("modeClassic").classList.toggle("active", mode==="classic");
      document.getElementById("modeLizard").classList.toggle("active", mode==="rpsls");

      renderChoices();
      updateHeader();
      updateScoreUI();
      save();
      showToast(mode==="classic" ? "Classic mode" : "RPSLS mode");
      buzz(12);
      beep("tap");
    }

    function updateFirstTo(v){
      state.firstTo = clamp(parseInt(v,10) || 7, 3, 15);
      updateHeader();
      updateScoreUI();
      save();
    }

    function setSkill(v){
      state.skill = clamp(parseInt(v,10) || 50, 0, 100);
      updateHeader();
      save();
    }
    function setHaptics(on){ state.haptics = !!on; updateHeader(); save(); }
    function setSounds(on){ state.sounds = !!on; updateHeader(); save(); }
    function setConfetti(on){ state.confetti = !!on; updateHeader(); save(); }

    // Gameplay
    let locked = false;

    function play(playerMove){
      if (locked) return;
      locked = true;

      const mode = MODES[state.mode];
      const emoji = mode.emoji;

      // Visual: select button
      document.querySelectorAll(".choiceBtn").forEach(b=> b.classList.toggle("selected", b.dataset.move === playerMove));

      el.playerDisplay.textContent = emoji[playerMove] || "‚ùì";
      el.playerDisplay.classList.add("active");
      el.lastPlayer.textContent = playerMove;

      // suspense
      el.cpuDisplay.textContent = "‚è≥";
      el.cpuDisplay.classList.add("active");

      el.resultText.textContent = "Thinking‚Ä¶";
      setTag("ready");
      flashResult();

      buzz(10);
      beep("tap");

      // Decide CPU move after a beat
      setTimeout(()=>{
        const cpuMove = pickCpuMove(playerMove);
        el.cpuDisplay.textContent = emoji[cpuMove] || "‚ùì";
        el.lastCpu.textContent = cpuMove;

        // Determine outcome
        const outcome = judge(playerMove, cpuMove);
        applyOutcome(outcome, playerMove, cpuMove);

        // Clear highlights
        setTimeout(()=>{
          el.playerDisplay.classList.remove("active");
          el.cpuDisplay.classList.remove("active");
          document.querySelectorAll(".choiceBtn").forEach(b=> b.classList.remove("selected"));
        }, 500);

        locked = false;
      }, 520 + Math.random()*220);
    }

    function judge(p, c){
      if (p === c) return "tie";
      if (BEATS[p] && BEATS[p].has(c)) return "win";
      return "lose";
    }

    function applyOutcome(outcome, p, c){
      // history tracking
      state.history.player.push(p);
      state.history.cpu.push(c);
      if (state.history.player.length > 30) state.history.player.shift();
      if (state.history.cpu.length > 30) state.history.cpu.shift();

      let msg = "";
      if (outcome === "tie"){
        state.score.ties++;
        state.streak = 0;
        msg = `Tie. Both chose ${p.toUpperCase()}. Civility wins.`;
        setTag("tie");
        buzz([10,40,10]);
        beep("tie");
      }else if (outcome === "win"){
        state.score.wins++;
        state.streak++;
        msg = `You win. ${p.toUpperCase()} beats ${c.toUpperCase()}. ‚ú®`;
        setTag("win");
        buzz(18);
        beep("win");
        if (state.confetti) confettiBurst();
      }else{
        state.score.losses++;
        state.streak = 0;
        msg = `You lose. ${c.toUpperCase()} beats ${p.toUpperCase()}.`;
        setTag("lose");
        buzz(30);
        beep("lose");
      }

      el.resultText.textContent = msg;
      flashResult();

      state.round++;
      el.roundNum.textContent = String(state.round);
      updateHeader();
      updateScoreUI();
      save();

      // Match end
      if (state.score.wins >= state.firstTo){
        endMatch(true);
      }else if (state.score.losses >= state.firstTo){
        endMatch(false);
      }
    }

    // CPU: blended randomness + pattern adaptation based on "skill"
    function pickCpuMove(playerMove){
      const mode = MODES[state.mode];
      const moves = mode.moves;

      // Base random
      const base = moves[Math.floor(Math.random() * moves.length)];

      // If skill low, mostly random
      if (state.skill <= 10) return base;

      // Predict player's next move from simple frequency + last-move bias
      const predicted = predictPlayerNext(moves);

      // Convert skill into probability of ‚Äúsmart pick‚Äù
      const smartChance = state.skill / 100; // 0..1
      const roll = Math.random();

      if (roll > smartChance) return base;

      // Choose a counter move that beats predicted move
      const counters = moves.filter(m => BEATS[m] && BEATS[m].has(predicted));
      if (counters.length === 0) return base;

      // Slight spice: sometimes pick a different counter to avoid being predictable
      return counters[Math.floor(Math.random() * counters.length)];
    }

    function predictPlayerNext(moves){
      const h = state.history.player;
      if (h.length === 0) return moves[Math.floor(Math.random() * moves.length)];

      // Frequency map
      const freq = new Map(moves.map(m=>[m,0]));
      h.forEach(m => freq.set(m, (freq.get(m)||0)+1));

      // Last-move bias (people repeat moves!)
      const last = h[h.length-1];
      freq.set(last, (freq.get(last)||0) + 2);

      // If streaky, add bias toward the last winning move (human confidence!)
      // Approx: if you have any history, bias toward most recent move.
      // (We keep this tiny to avoid ‚Äúcheating‚Äù vibes.)
      if (state.streak >= 2) freq.set(last, (freq.get(last)||0) + 1);

      // Pick max
      let best = moves[0], bestV = -Infinity;
      for (const m of moves){
        const v = freq.get(m) || 0;
        if (v > bestV){ bestV = v; best = m; }
      }
      return best;
    }

    // Autoplay
    function toggleAutoPlay(){
      if (state.autoplay) stopAutoPlay();
      else startAutoPlay();
    }
    function startAutoPlay(){
      if (state.autoplay) return;
      state.autoplay = true;
      el.autoplayBtn.textContent = "‚è∏Ô∏è Stop";
      el.autoplayBtn.classList.add("primary");
      showToast("Autoplay ON");
      buzz(12);

      state.autoplayId = setInterval(()=>{
        if (locked) return;
        const mode = MODES[state.mode];
        const playerMove = mode.moves[Math.floor(Math.random() * mode.moves.length)];
        play(playerMove);
      }, 1200);
      save();
    }
    function stopAutoPlay(){
      if (state.autoplayId) clearInterval(state.autoplayId);
      state.autoplayId = null;
      state.autoplay = false;
      el.autoplayBtn.textContent = "‚ñ∂Ô∏è Auto";
      el.autoplayBtn.classList.remove("primary");
      showToast("Autoplay OFF");
      save();
    }

    // Reset
    function resetGame(){
      stopAutoPlay();
      state.score = { wins:0, losses:0, ties:0 };
      state.streak = 0;
      state.round = 1;
      state.history.player = [];
      state.history.cpu = [];
      el.playerDisplay.textContent = "‚ùì";
      el.cpuDisplay.textContent = "‚ùì";
      el.lastPlayer.textContent = "‚Äî";
      el.lastCpu.textContent = "‚Äî";
      el.resultText.textContent = "Reset. Fresh start. (No grudges‚Ä¶ allegedly.)";
      setTag("ready");
      updateHeader();
      updateScoreUI();
      flashResult();
      save();
      buzz(20);
      beep("tap");
    }

    // Copy / Share
    async function copyStats(){
      const mode = MODES[state.mode];
      const text =
`RPS+ (${mode.title})
Wins: ${state.score.wins}  Losses: ${state.score.losses}  Ties: ${state.score.ties}
Streak: ${state.streak}  First-to: ${state.firstTo}  Skill: ${state.skill}`;
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copied!");
      }catch(e){
        showToast("Copy blocked (browser).");
      }
      buzz(10);
    }

    async function shareScore(){
      const mode = MODES[state.mode];
      const text =
`RPS+ (${mode.title}) ‚Äî Wins ${state.score.wins}, Losses ${state.score.losses}, Ties ${state.score.ties}. Streak ${state.streak}.`;
      try{
        if (navigator.share){
          await navigator.share({ title:"RPS+", text });
          showToast("Shared!");
        }else{
          await navigator.clipboard.writeText(text);
          showToast("Share not supported ‚Äî copied instead.");
        }
      }catch(e){
        showToast("Share canceled.");
      }
    }

    // Settings modal
    function openSettings(){
      el.settingsModal.showModal();
      buzz(10);
      beep("tap");
    }
    function closeSettings(){
      el.settingsModal.close();
      buzz(10);
      beep("tap");
    }

    // Confetti (lightweight canvas burst)
    let confettiCtx = null;
    let confettiRAF = null;
    let confettiPieces = [];

    function confettiBurst(){
      const canvas = el.confettiCanvas;
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = "100%";
      canvas.style.height = "100%";

      confettiCtx = canvas.getContext("2d");
      confettiCtx.setTransform(dpr,0,0,dpr,0,0);

      const count = 90;
      const centerX = window.innerWidth * 0.5;
      const centerY = window.innerHeight * 0.28;

      confettiPieces = [];
      for (let i=0; i<count; i++){
        const a = Math.random() * Math.PI * 2;
        const s = 2 + Math.random() * 5;
        confettiPieces.push({
          x: centerX,
          y: centerY,
          vx: Math.cos(a) * (2 + Math.random()*6),
          vy: Math.sin(a) * (2 + Math.random()*6) - 4,
          w: 3 + Math.random()*5,
          h: 6 + Math.random()*8,
          r: (Math.random()*Math.PI),
          vr: (-0.2 + Math.random()*0.4),
          life: 80 + Math.random()*30
        });
      }

      cancelAnimationFrame(confettiRAF);
      confettiRAF = requestAnimationFrame(confettiTick);
    }

    function confettiTick(){
      if (!confettiCtx) return;
      confettiCtx.clearRect(0,0,window.innerWidth,window.innerHeight);

      // draw
      for (const p of confettiPieces){
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.22; // gravity
        p.r += p.vr;
        p.life -= 1;

        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate(p.r);
        confettiCtx.globalAlpha = Math.max(0, Math.min(1, p.life/110));
        // no hard-coded colors: use gradients that match theme
        const grad = confettiCtx.createLinearGradient(-p.w,0,p.w,0);
        grad.addColorStop(0, "rgba(124,58,237,.9)");
        grad.addColorStop(1, "rgba(6,182,212,.9)");
        confettiCtx.fillStyle = grad;
        confettiCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        confettiCtx.restore();
      }

      confettiPieces = confettiPieces.filter(p => p.life > 0 && p.y < window.innerHeight + 60);

      if (confettiPieces.length){
        confettiRAF = requestAnimationFrame(confettiTick);
      }else{
        confettiCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
      }
    }

    function endMatch(won){
      stopAutoPlay();
      const msg = won
        ? `üèÜ Match won! First to ${state.firstTo}. Steve Jobs smiles somewhere.`
        : `üí• Match lost. First to ${state.firstTo}. Recalibrate, return stronger.`;

      el.resultText.textContent = msg;
      setTag(won ? "win" : "lose");
      flashResult();
      if (won && state.confetti) confettiBurst();

      // soft-lock: start a new match but keep lifetime score? We'll reset match score only.
      // For now: reset match score only after a moment (keeps it flowing on mobile).
      setTimeout(()=>{
        state.score = { wins:0, losses:0, ties:0 };
        state.round = 1;
        state.streak = 0;
        state.history.player = [];
        state.history.cpu = [];
        updateHeader();
        updateScoreUI();
        save();
        showToast("New match ready");
      }, 1400);
    }

    // Utilities
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    // Keyboard shortcuts (desktop)
    document.addEventListener("keydown", (e)=>{
      if (e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;
      const mode = MODES[state.mode];
      const k = (e.key || "").toLowerCase();
      if (k === "escape" && el.settingsModal.open) closeSettings();
      if (k === " "){ e.preventDefault(); toggleAutoPlay(); return; }
      const move = mode.keys[k];
      if (move) play(move);
    });

    // Wire settings button
    el.settingsBtn.addEventListener("click", openSettings);

    // Close on click outside (nice on mobile)
    el.settingsModal.addEventListener("click", (e)=>{
      const r = el.settingsModal.getBoundingClientRect();
      const inDialog = (r.top <= e.clientY && e.clientY <= r.bottom && r.left <= e.clientX && e.clientX <= r.right);
      if (!inDialog) closeSettings();
    });

    // Startup
    function init(){
      load();
      // ensure range reflects state
      el.firstTo.value = String(state.firstTo);
      document.getElementById("modeClassic").classList.toggle("active", state.mode==="classic");
      document.getElementById("modeLizard").classList.toggle("active", state.mode==="rpsls");
      renderChoices();
      updateHeader();
      updateScoreUI();
      setTag("ready");

      if (state.autoplay) {
        // in case it was saved as ON, start fresh
        state.autoplay = false;
        state.autoplayId = null;
        save();
      }
    }

    // Resize confetti canvas if needed
    window.addEventListener("resize", ()=>{
      // canvas auto fits on next burst; no need to do anything heavy here
    });

    init();
  </script>
</body>
</html>
